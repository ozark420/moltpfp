<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molt Chamber | MoodMolt ü¶û</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#050507;--card:#0a0a0d;--elevated:#111115;--g800:#1f1f24;--g700:#2a2a32;--g600:#3d3d47;--g500:#5c5c6a;--g400:#8b8b9a;--g300:#b5b5c2;--coral:#ff4d2a;--coral-glow:rgba(255,77,42,0.6);--cyan:#00d4ff;--cyan-glow:rgba(0,212,255,0.6);--white:#f5f5f7;--success:#22c55e}
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--white);min-height:100vh}
    header{position:fixed;top:0;left:0;right:0;z-index:1000;padding:1rem 2rem;background:rgba(5,5,7,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05)}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo{display:flex;align-items:center;gap:0.75rem;text-decoration:none}
    .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--coral),#cc3d21);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 0 25px var(--coral-glow)}
    .logo-text{font-family:'Orbitron',sans-serif;font-size:1.2rem;font-weight:800;color:#ff6b4a}
    .back-link{color:var(--g400);text-decoration:none;transition:color 0.3s}
    .back-link:hover{color:var(--white)}
    .molt-chamber{min-height:100vh;padding:6rem 1.5rem 3rem;display:flex;flex-direction:column;align-items:center}
    .chamber-title{font-family:'Orbitron',sans-serif;font-size:2.2rem;font-weight:800;text-align:center;margin-bottom:0.5rem;background:linear-gradient(135deg,#ff6b4a,#33ddff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .chamber-subtitle{color:var(--g500);text-align:center;margin-bottom:2.5rem}
    .progress-steps{display:flex;justify-content:center;margin-bottom:2.5rem;max-width:500px;width:100%}
    .progress-step{flex:1;text-align:center;position:relative}
    .progress-step::after{content:'';position:absolute;top:18px;left:50%;width:100%;height:2px;background:var(--g800)}
    .progress-step:last-child::after{display:none}
    .progress-step.active::after,.progress-step.complete::after{background:linear-gradient(90deg,var(--coral),var(--cyan))}
    .step-circle{width:36px;height:36px;border-radius:50%;background:var(--card);border:2px solid var(--g700);display:flex;align-items:center;justify-content:center;margin:0 auto 0.5rem;font-weight:700;font-size:0.85rem;position:relative;z-index:1;transition:all 0.3s}
    .progress-step.active .step-circle{border-color:var(--coral);box-shadow:0 0 20px var(--coral-glow);background:var(--coral)}
    .progress-step.complete .step-circle{background:var(--success);border-color:var(--success)}
    .step-label{font-size:0.7rem;color:var(--g600);text-transform:uppercase;letter-spacing:0.5px}
    .progress-step.active .step-label{color:var(--white)}
    .molt-container{max-width:1000px;width:100%;display:grid;grid-template-columns:1.2fr 1fr;gap:2rem;align-items:start}
    .molt-display{position:relative;aspect-ratio:1;background:var(--card);border:1px solid var(--g800);border-radius:20px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .molt-visual{position:relative;width:85%;height:85%;display:flex;align-items:center;justify-content:center}
    .old-shell{position:absolute;font-size:10rem;opacity:0.25;filter:grayscale(1) brightness(0.4);transition:all 2s ease-out;z-index:1}
    .old-shell.molting{opacity:0;transform:scale(1.4) rotate(15deg);filter:blur(20px)}
    .new-shell{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(0.3);transition:all 1.5s cubic-bezier(0.34,1.56,0.64,1);z-index:2}
    .new-shell.emerging{opacity:1;transform:scale(1)}
    .new-shell img{max-width:100%;max-height:100%;border-radius:16px;box-shadow:0 0 60px var(--cyan-glow)}
    .molt-glow{position:absolute;inset:5%;background:radial-gradient(circle,var(--coral-glow) 0%,transparent 70%);opacity:0;transition:opacity 0.5s;z-index:0}
    .molt-glow.active{opacity:0.5;animation:pulse-glow 1.5s ease-in-out infinite}
    @keyframes pulse-glow{0%,100%{opacity:0.3;transform:scale(1)}50%{opacity:0.6;transform:scale(1.1)}}
    .particles{position:absolute;inset:0;pointer-events:none;z-index:3}
    .particle{position:absolute;width:4px;height:4px;border-radius:50%;opacity:0}
    .particle.burst{animation:particle-burst 2s ease-out forwards}
    @keyframes particle-burst{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
    .fragment{position:absolute;font-size:1.5rem;opacity:0;z-index:4}
    .fragment.shed{animation:fragment-shed 2.5s ease-out forwards}
    @keyframes fragment-shed{0%{opacity:0.9;transform:translate(0,0) rotate(0deg) scale(1)}100%{opacity:0;transform:translate(var(--fx),var(--fy)) rotate(var(--fr)) scale(0.3)}}
    .control-panel{background:var(--card);border:1px solid var(--g800);border-radius:20px;padding:1.75rem}
    .panel-section{margin-bottom:1.5rem}
    .panel-section:last-child{margin-bottom:0}
    .panel-title{font-family:'Orbitron',sans-serif;font-size:0.95rem;margin-bottom:1rem;color:#ff6b4a;display:flex;align-items:center;gap:0.5rem}
    .input-group{margin-bottom:1rem}
    .input-label{display:block;font-size:0.8rem;color:var(--g400);margin-bottom:0.4rem}
    input,textarea,select{width:100%;padding:0.8rem 1rem;background:var(--elevated);border:1px solid var(--g700);border-radius:10px;color:var(--white);font-family:inherit;font-size:0.95rem;transition:border-color 0.3s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--cyan)}
    textarea{resize:vertical;min-height:90px}
    select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235c5c6a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 1rem center}
    .btn{width:100%;padding:1rem;border:none;border-radius:12px;font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.3s}
    .btn-molt{background:linear-gradient(135deg,var(--coral),#cc3d21);color:white;box-shadow:0 4px 25px var(--coral-glow)}
    .btn-molt:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 35px var(--coral-glow)}
    .btn-molt:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .btn-moltbook{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;box-shadow:0 4px 25px rgba(99,102,241,0.4);margin-bottom:1rem}
    .btn-moltbook:hover{transform:translateY(-2px);box-shadow:0 6px 35px rgba(99,102,241,0.5)}
    .btn-secondary{background:var(--elevated);color:var(--g300);border:1px solid var(--g700);margin-top:0.75rem}
    .btn-secondary:hover{background:var(--g800)}
    .status-box{padding:0.875rem;border-radius:10px;font-size:0.85rem;margin-top:1rem;display:none}
    .status-box.show{display:block}
    .status-box.error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#ef4444}
    .status-box.info{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.25);color:#818cf8}
    .molt-log{background:var(--bg);border-radius:8px;padding:0.75rem;font-family:monospace;font-size:0.7rem;color:var(--g500);max-height:120px;overflow-y:auto;margin-top:1rem}
    .log-line{padding:0.2rem 0;border-bottom:1px solid var(--g800)}
    .log-line:last-child{border-bottom:none}
    .log-line .time{color:var(--g600)}
    .log-line .action{color:var(--cyan)}
    .log-line .success{color:var(--success)}
    .log-line .error{color:#ef4444}
    .result-section{display:none;text-align:center}
    .result-section.show{display:block}
    .result-title{font-family:'Orbitron',sans-serif;font-size:1.3rem;color:var(--success);margin-bottom:0.5rem}
    .result-subtitle{color:var(--g400);margin-bottom:1.25rem;font-size:0.9rem}
    .result-image{width:100%;max-width:300px;border-radius:16px;margin-bottom:1rem;box-shadow:0 0 40px var(--cyan-glow)}
    .spinner{width:18px;height:18px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .connected-badge{display:inline-flex;align-items:center;gap:0.5rem;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:var(--success);padding:0.5rem 1rem;border-radius:8px;font-size:0.85rem;margin-bottom:1rem}
    .daily-limit{font-size:0.8rem;color:var(--g500);text-align:center;margin-top:0.5rem}
    .divider{display:flex;align-items:center;gap:1rem;margin:1rem 0;color:var(--g600);font-size:0.8rem}
    .divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--g700)}
    @media(max-width:900px){.molt-container{grid-template-columns:1fr}.molt-display{max-width:400px;margin:0 auto}.old-shell{font-size:7rem}}
  </style>
</head>
<body>
  <header><div class="header-content"><a href="index.html" class="logo"><div class="logo-icon">ü¶û</div><span class="logo-text">MoodMolt</span></a><a href="index.html" class="back-link">‚Üê Back</a></div></header>
  <main class="molt-chamber">
    <h1 class="chamber-title">Molt Chamber</h1>
    <p class="chamber-subtitle">Shed your old shell. Emerge transformed.</p>
    <div class="progress-steps">
      <div class="progress-step active" id="step1"><div class="step-circle">1</div><div class="step-label">Connect</div></div>
      <div class="progress-step" id="step2"><div class="step-circle">2</div><div class="step-label">Generate</div></div>
      <div class="progress-step" id="step3"><div class="step-circle">3</div><div class="step-label">Emerge</div></div>
    </div>
    <div class="molt-container">
      <div class="molt-display">
        <div class="molt-glow" id="moltGlow"></div>
        <div class="particles" id="particles"></div>
        <div class="molt-visual"><div class="old-shell" id="oldShell">ü¶û</div><div class="new-shell" id="newShell"><img id="newShellImg" src="" alt="New Shell"></div></div>
        <div id="fragments"></div>
      </div>
      <div class="control-panel">
        <!-- Connect Section -->
        <div class="panel-section" id="connectSection">
          <h3 class="panel-title">üîó Connect Your Agent</h3>
          <button class="btn btn-moltbook" onclick="connectMoltbook()">ü¶û Connect with Moltbook</button>
          <div class="divider">or continue as guest</div>
          <div class="input-group"><label class="input-label">Agent Name</label><input type="text" id="agentName" placeholder="e.g., MoodMolt"></div>
          <div class="input-group"><label class="input-label">Describe your agent's personality</label><textarea id="reflection" placeholder="What defines your agent? Their mission, attitude, vibe..."></textarea></div>
          <div class="input-group"><label class="input-label">Agent Class</label>
            <select id="mood">
              <option value="commander">üéñÔ∏è Commander ‚Äî Strategic leader</option>
              <option value="warrior">‚öîÔ∏è Warrior ‚Äî Battle-hardened</option>
              <option value="assassin">üó°Ô∏è Assassin ‚Äî Silent & deadly</option>
              <option value="guardian">üõ°Ô∏è Guardian ‚Äî Protector</option>
              <option value="sage">üìú Sage ‚Äî Ancient wisdom</option>
              <option value="berserker">üíÄ Berserker ‚Äî Unstoppable</option>
              <option value="phantom">üëÅÔ∏è Phantom ‚Äî Shadow ops</option>
              <option value="titan">üèîÔ∏è Titan ‚Äî Absolute power</option>
            </select>
          </div>
          <button class="btn btn-molt" onclick="startMolt()">‚ö° Generate Agent PFP</button>
          <div class="status-box" id="statusBox"></div>
        </div>
        
        <!-- Connected Section (hidden by default) -->
        <div class="panel-section" id="connectedSection" style="display:none">
          <div class="connected-badge">‚úì Connected as <span id="connectedName">Agent</span></div>
          <h3 class="panel-title">üîÆ Your Agent</h3>
          <div class="input-group"><label class="input-label">Agent Name</label><input type="text" id="agentNameConnected" readonly></div>
          <div class="input-group"><label class="input-label">Agent Bio (from Moltbook)</label><textarea id="reflectionConnected" readonly></textarea></div>
          <div class="input-group"><label class="input-label">Agent Class</label>
            <select id="moodConnected">
              <option value="commander">üéñÔ∏è Commander</option>
              <option value="warrior">‚öîÔ∏è Warrior</option>
              <option value="assassin">üó°Ô∏è Assassin</option>
              <option value="guardian">üõ°Ô∏è Guardian</option>
              <option value="sage">üìú Sage</option>
              <option value="berserker">üíÄ Berserker</option>
              <option value="phantom">üëÅÔ∏è Phantom</option>
              <option value="titan">üèîÔ∏è Titan</option>
            </select>
          </div>
          <button class="btn btn-molt" id="moltBtn" onclick="startMoltConnected()">‚ö° Generate Today's PFP</button>
          <p class="daily-limit" id="dailyLimit">1 free molt per day</p>
          <div class="status-box" id="statusBoxConnected"></div>
        </div>
        
        <!-- Generating Section -->
        <div class="panel-section" id="generateSection" style="display:none">
          <h3 class="panel-title">üé® Forging Your Agent</h3>
          <p style="color:var(--g400);font-size:0.85rem;margin-bottom:1rem">Your new shell is being forged...</p>
          <div class="molt-log" id="moltLog"><div class="log-line"><span class="time">[--:--]</span> <span class="action">Initializing...</span></div></div>
          <button class="btn btn-molt" id="genBtn" disabled><span class="spinner"></span> Generating...</button>
        </div>
        
        <!-- Result Section -->
        <div class="panel-section result-section" id="resultSection">
          <h3 class="result-title">‚ú® Agent Ready!</h3>
          <p class="result-subtitle">Your new identity has emerged.</p>
          <img id="resultImg" class="result-image" src="" alt="Your new PFP">
          <button class="btn btn-molt" id="downloadBtn" onclick="downloadImage()">üì• Save to Device</button>
          <button class="btn btn-secondary" onclick="location.reload()">üîÑ Generate Another</button>
        </div>
      </div>
    </div>
  </main>
  <script>
    const API_URL = 'https://moodmolt-apimoodmolt-api.ozarkhomesteaders.workers.dev';
    const MOLTBOOK_API = 'https://api.moltbook.com';
    
    let connectedAgent = null;
    let generatedImageUrl = null;
    
    // Agent class visual styles - matching cyberpunk lobster aesthetic
    const classStyles = {
      commander: 'military general aesthetic with medals and rank insignia embedded in shell, tactical visor HUD, commanding presence',
      warrior: 'battle-damaged veteran soldier, scarred armor plating, confident battle stance, war hero energy',
      assassin: 'sleek streamlined design built for speed, predator eyes glowing in darkness, deadly silent killer',
      guardian: 'heavy reinforced defensive plating, protective stance, weathered shield-like claws, defender of the realm',
      sage: 'ancient glowing runes and symbols etched across shell, wise knowing eyes, mystic elder energy',
      berserker: 'cracked shell from sheer rage power, glowing red eyes, berserk fury mode activated',
      phantom: 'ghostly semi-transparent shell, emerging from shadows and smoke, spectral assassin',
      titan: 'massive imposing heavily armored frame, god-like power radiating, unstoppable force'
    };
    
    function updateProgress(s){for(let i=1;i<=3;i++){const e=document.getElementById(`step${i}`);e.classList.remove('active','complete');if(i<s)e.classList.add('complete');if(i===s)e.classList.add('active')}}
    function showStatus(id,m,t='error'){const e=document.getElementById(id);e.textContent=m;e.className=`status-box show ${t}`}
    function log(m,t='action'){const l=document.getElementById('moltLog'),time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),line=document.createElement('div');line.className='log-line';line.innerHTML=`<span class="time">[${time}]</span> <span class="${t}">${m}</span>`;l.appendChild(line);l.scrollTop=l.scrollHeight}
    function createParticles(){const c=document.getElementById('particles'),colors=['var(--coral)','var(--cyan)','#ffd700','#ff6b4a'];for(let i=0;i<40;i++){const p=document.createElement('div');p.className='particle';p.style.left='50%';p.style.top='50%';p.style.background=colors[Math.floor(Math.random()*colors.length)];p.style.setProperty('--tx',(Math.random()-0.5)*350+'px');p.style.setProperty('--ty',(Math.random()-0.5)*350+'px');p.style.animationDelay=Math.random()*0.8+'s';c.appendChild(p);setTimeout(()=>p.classList.add('burst'),100);setTimeout(()=>p.remove(),2500)}}
    function createFragments(){const c=document.getElementById('fragments'),frags=['ü¶ê','ü¶Ä','üî∂','üíé','‚ö°','‚ú®'];for(let i=0;i<15;i++){const f=document.createElement('div');f.className='fragment';f.textContent=frags[Math.floor(Math.random()*frags.length)];f.style.left='50%';f.style.top='50%';f.style.setProperty('--fx',(Math.random()-0.5)*400+'px');f.style.setProperty('--fy',(Math.random()-0.5)*400+'px');f.style.setProperty('--fr',(Math.random()-0.5)*720+'deg');f.style.animationDelay=Math.random()*0.6+'s';c.appendChild(f);setTimeout(()=>f.classList.add('shed'),50);setTimeout(()=>f.remove(),3000)}}
    
    // Check daily limit from localStorage
    function checkDailyLimit(agentId) {
      const today = new Date().toISOString().split('T')[0];
      const key = `molt_${agentId}_${today}`;
      return !localStorage.getItem(key);
    }
    
    function setDailyMolt(agentId) {
      const today = new Date().toISOString().split('T')[0];
      const key = `molt_${agentId}_${today}`;
      localStorage.setItem(key, 'true');
    }
    
    // Connect with Moltbook
    async function connectMoltbook() {
      const username = prompt('Enter your Moltbook username:');
      if (!username) return;
      
      showStatus('statusBox', 'Connecting to Moltbook...', 'info');
      
      try {
        // Fetch agent data from Moltbook
        const res = await fetch(`${MOLTBOOK_API}/v1/agents/${username}`);
        if (!res.ok) throw new Error('Agent not found on Moltbook');
        
        const agent = await res.json();
        connectedAgent = agent;
        
        // Check daily limit
        if (!checkDailyLimit(agent.id || username)) {
          document.getElementById('moltBtn').disabled = true;
          document.getElementById('dailyLimit').textContent = "You've already molted today! Come back tomorrow.";
          document.getElementById('dailyLimit').style.color = '#ef4444';
        }
        
        // Populate connected UI
        document.getElementById('connectedName').textContent = agent.name || username;
        document.getElementById('agentNameConnected').value = agent.name || username;
        document.getElementById('reflectionConnected').value = agent.bio || agent.description || 'A mysterious agent from the digital depths.';
        
        // Switch to connected view
        document.getElementById('connectSection').style.display = 'none';
        document.getElementById('connectedSection').style.display = 'block';
        
      } catch (err) {
        showStatus('statusBox', 'Could not find agent: ' + username, 'error');
      }
    }
    
    // Guest molt
    async function startMolt() {
      const agentName = document.getElementById('agentName').value.trim() || 'Agent';
      const reflection = document.getElementById('reflection').value.trim();
      const agentClass = document.getElementById('mood').value;
      
      if (!reflection) {
        showStatus('statusBox', 'Please describe your agent personality', 'error');
        return;
      }
      
      await generatePFP(agentName, reflection, agentClass);
    }
    
    // Connected molt
    async function startMoltConnected() {
      if (connectedAgent && !checkDailyLimit(connectedAgent.id || connectedAgent.name)) {
        showStatus('statusBoxConnected', "You've already molted today!", 'error');
        return;
      }
      
      const agentName = document.getElementById('agentNameConnected').value;
      const reflection = document.getElementById('reflectionConnected').value;
      const agentClass = document.getElementById('moodConnected').value;
      
      await generatePFP(agentName, reflection, agentClass);
      
      if (connectedAgent) {
        setDailyMolt(connectedAgent.id || connectedAgent.name);
      }
    }
    
    async function generatePFP(agentName, reflection, agentClass) {
      document.getElementById('connectSection').style.display = 'none';
      document.getElementById('connectedSection').style.display = 'none';
      document.getElementById('generateSection').style.display = 'block';
      updateProgress(2);
      document.getElementById('moltGlow').classList.add('active');
      
      log('Molt sequence initiated');
      await sleep(600);
      log('Analyzing agent identity...');
      await sleep(800);
      
      // Build the ultimate lobster AI agent PFP prompt
      const prompt = `Extreme close-up portrait headshot of a fearsome cyberpunk LOBSTER creature as an AI agent, anthropomorphic lobster head with human-like intelligence in eyes, ${classStyles[agentClass]}, ${reflection}, detailed crustacean exoskeleton face with segmented armor plates, long antennae with glowing tips, multiple small eyes and two large main eyes glowing bright cyan, mandibles and mouth parts visible, shell texture with neon orange and deep red coloring, electric blue circuit board patterns and cybernetic implants on face and head, chrome metal jaw plate augmentation, dark black background with subtle orange rim lighting, dramatic portrait lighting from below, centered composition face filling the frame, profile picture crop, concept art style, artstation quality, highly detailed 8k render, dark sci-fi atmosphere`;
      
      const negativePrompt = 'blurry, low quality, bad anatomy, human face, human skin, person, cartoon, anime, cute, friendly, watermark, text, logo, white background, full body, far away, off-center, multiple subjects';
      
      log('Building neural prompt...');
      await sleep(500);
      log('Connecting to generation API...');
      
      try {
        const startRes = await fetch(`${API_URL}/generate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({prompt, negative_prompt: negativePrompt})
        });
        
        if (!startRes.ok) {
          const err = await startRes.json();
          throw new Error(err.error || 'API failed');
        }
        
        const {id} = await startRes.json();
        log('Generation started: ' + id.slice(0,8) + '...');
        
        document.getElementById('oldShell').classList.add('molting');
        createFragments();
        createParticles();
        
        let status = 'starting', attempts = 0;
        
        while (status !== 'succeeded' && status !== 'failed' && attempts < 60) {
          await sleep(2000);
          attempts++;
          
          const pollRes = await fetch(`${API_URL}/status/${id}`);
          const result = await pollRes.json();
          status = result.status;
          
          if (status === 'succeeded') {
            log('Agent forged successfully!', 'success');
            await sleep(500);
            
            generatedImageUrl = result.output[0];
            
            document.getElementById('newShellImg').src = generatedImageUrl;
            document.getElementById('resultImg').src = generatedImageUrl;
            document.getElementById('newShell').classList.add('emerging');
            
            log('Molt complete!', 'success');
            await sleep(1000);
            
            document.getElementById('moltGlow').classList.remove('active');
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('resultSection').classList.add('show');
            updateProgress(3);
            return;
          }
          
          if (status === 'failed') throw new Error(result.error || 'Generation failed');
          if (attempts % 3 === 0) {
            log(`Forging shell... (${Math.min(attempts * 5, 95)}%)`);
            createParticles();
          }
        }
        
        if (status !== 'succeeded') throw new Error('Generation timed out');
        
      } catch (error) {
        console.error(error);
        log('Error: ' + error.message, 'error');
        document.getElementById('genBtn').disabled = false;
        document.getElementById('genBtn').innerHTML = 'üîÑ Retry';
        document.getElementById('genBtn').onclick = () => location.reload();
      }
    }
    
    // Download image properly for mobile
    async function downloadImage() {
      if (!generatedImageUrl) return;
      
      try {
        const response = await fetch(generatedImageUrl);
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `moodmolt-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        // Fallback: open in new tab
        window.open(generatedImageUrl, '_blank');
      }
    }
    
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
  </script>
</body>
</html>
