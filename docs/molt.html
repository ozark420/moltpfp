<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molt Chamber | MoodMolt ü¶û</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#050507;--card:#0a0a0d;--elevated:#111115;--g800:#1f1f24;--g700:#2a2a32;--g600:#3d3d47;--g500:#5c5c6a;--g400:#8b8b9a;--g300:#b5b5c2;--coral:#ff4d2a;--coral-glow:rgba(255,77,42,0.6);--cyan:#00d4ff;--cyan-glow:rgba(0,212,255,0.6);--white:#f5f5f7;--success:#22c55e}
    body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--white);min-height:100vh}
    header{position:fixed;top:0;left:0;right:0;z-index:1000;padding:1rem 2rem;background:rgba(5,5,7,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05)}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo{display:flex;align-items:center;gap:0.75rem;text-decoration:none}
    .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--coral),#cc3d21);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 0 25px var(--coral-glow)}
    .logo-text{font-family:'Orbitron',sans-serif;font-size:1.2rem;font-weight:800;color:#ff6b4a}
    .back-link{color:var(--g400);text-decoration:none;transition:color 0.3s}
    .back-link:hover{color:var(--white)}
    .molt-chamber{min-height:100vh;padding:6rem 1.5rem 3rem;display:flex;flex-direction:column;align-items:center}
    .chamber-title{font-family:'Orbitron',sans-serif;font-size:2.2rem;font-weight:800;text-align:center;margin-bottom:0.5rem;background:linear-gradient(135deg,#ff6b4a,#33ddff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .chamber-subtitle{color:var(--g500);text-align:center;margin-bottom:2rem}
    
    /* Mode Toggle */
    .mode-toggle{display:flex;justify-content:center;gap:0;margin-bottom:2rem;background:var(--card);border-radius:12px;padding:4px;max-width:300px}
    .mode-btn{flex:1;padding:0.75rem 1.5rem;border:none;background:transparent;color:var(--g400);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:0.5rem}
    .mode-btn.active{background:var(--coral);color:white;box-shadow:0 2px 15px var(--coral-glow)}
    .mode-btn:hover:not(.active){color:var(--white)}
    
    .progress-steps{display:flex;justify-content:center;margin-bottom:2rem;max-width:500px;width:100%}
    .progress-step{flex:1;text-align:center;position:relative}
    .progress-step::after{content:'';position:absolute;top:18px;left:50%;width:100%;height:2px;background:var(--g800)}
    .progress-step:last-child::after{display:none}
    .progress-step.active::after,.progress-step.complete::after{background:linear-gradient(90deg,var(--coral),var(--cyan))}
    .step-circle{width:36px;height:36px;border-radius:50%;background:var(--card);border:2px solid var(--g700);display:flex;align-items:center;justify-content:center;margin:0 auto 0.5rem;font-weight:700;font-size:0.85rem;position:relative;z-index:1;transition:all 0.3s}
    .progress-step.active .step-circle{border-color:var(--coral);box-shadow:0 0 20px var(--coral-glow);background:var(--coral)}
    .progress-step.complete .step-circle{background:var(--success);border-color:var(--success)}
    .step-label{font-size:0.7rem;color:var(--g600);text-transform:uppercase;letter-spacing:0.5px}
    .progress-step.active .step-label{color:var(--white)}
    .molt-container{max-width:1000px;width:100%;display:grid;grid-template-columns:1.2fr 1fr;gap:2rem;align-items:start}
    .molt-display{position:relative;aspect-ratio:1;background:var(--card);border:1px solid var(--g800);border-radius:20px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .molt-visual{position:relative;width:85%;height:85%;display:flex;align-items:center;justify-content:center}
    .old-shell{position:absolute;font-size:10rem;opacity:0.25;filter:grayscale(1) brightness(0.4);transition:all 2s ease-out;z-index:1}
    .old-shell.molting{opacity:0;transform:scale(1.4) rotate(15deg);filter:blur(20px)}
    .new-shell{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:0;transform:scale(0.3);transition:all 1.5s cubic-bezier(0.34,1.56,0.64,1);z-index:2}
    .new-shell.emerging{opacity:1;transform:scale(1)}
    .new-shell img{max-width:100%;max-height:100%;border-radius:16px;box-shadow:0 0 60px var(--cyan-glow)}
    .molt-glow{position:absolute;inset:5%;background:radial-gradient(circle,var(--coral-glow) 0%,transparent 70%);opacity:0;transition:opacity 0.5s;z-index:0}
    .molt-glow.active{opacity:0.5;animation:pulse-glow 1.5s ease-in-out infinite}
    @keyframes pulse-glow{0%,100%{opacity:0.3;transform:scale(1)}50%{opacity:0.6;transform:scale(1.1)}}
    .particles{position:absolute;inset:0;pointer-events:none;z-index:3}
    .particle{position:absolute;width:4px;height:4px;border-radius:50%;opacity:0}
    .particle.burst{animation:particle-burst 2s ease-out forwards}
    @keyframes particle-burst{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
    .fragment{position:absolute;font-size:1.5rem;opacity:0;z-index:4}
    .fragment.shed{animation:fragment-shed 2.5s ease-out forwards}
    @keyframes fragment-shed{0%{opacity:0.9;transform:translate(0,0) rotate(0deg) scale(1)}100%{opacity:0;transform:translate(var(--fx),var(--fy)) rotate(var(--fr)) scale(0.3)}}
    .control-panel{background:var(--card);border:1px solid var(--g800);border-radius:20px;padding:1.75rem}
    .panel-section{margin-bottom:1.5rem}
    .panel-section:last-child{margin-bottom:0}
    .panel-title{font-family:'Orbitron',sans-serif;font-size:0.95rem;margin-bottom:1rem;color:#ff6b4a;display:flex;align-items:center;gap:0.5rem}
    .input-group{margin-bottom:1rem}
    .input-label{display:block;font-size:0.8rem;color:var(--g400);margin-bottom:0.4rem}
    input,textarea,select{width:100%;padding:0.8rem 1rem;background:var(--elevated);border:1px solid var(--g700);border-radius:10px;color:var(--white);font-family:inherit;font-size:0.95rem;transition:border-color 0.3s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--cyan)}
    textarea{resize:vertical;min-height:80px}
    select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235c5c6a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 1rem center}
    .btn{width:100%;padding:1rem;border:none;border-radius:12px;font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.3s}
    .btn-molt{background:linear-gradient(135deg,var(--coral),#cc3d21);color:white;box-shadow:0 4px 25px var(--coral-glow)}
    .btn-molt:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 35px var(--coral-glow)}
    .btn-molt:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .btn-moltbook{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;box-shadow:0 4px 25px rgba(99,102,241,0.4)}
    .btn-moltbook:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 35px rgba(99,102,241,0.5)}
    .btn-secondary{background:var(--elevated);color:var(--g300);border:1px solid var(--g700);margin-top:0.75rem}
    .btn-secondary:hover{background:var(--g800)}
    .status-box{padding:0.875rem;border-radius:10px;font-size:0.85rem;margin-top:1rem;display:none}
    .status-box.show{display:block}
    .status-box.error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#ef4444}
    .status-box.info{background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.25);color:#818cf8}
    .status-box.success{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.25);color:var(--success)}
    .molt-log{background:var(--bg);border-radius:8px;padding:0.75rem;font-family:monospace;font-size:0.7rem;color:var(--g500);max-height:120px;overflow-y:auto;margin-top:1rem}
    .log-line{padding:0.2rem 0;border-bottom:1px solid var(--g800)}
    .log-line:last-child{border-bottom:none}
    .log-line .time{color:var(--g600)}
    .log-line .action{color:var(--cyan)}
    .log-line .success{color:var(--success)}
    .log-line .error{color:#ef4444}
    .result-section{display:none;text-align:center}
    .result-section.show{display:block}
    .result-title{font-family:'Orbitron',sans-serif;font-size:1.3rem;color:var(--success);margin-bottom:0.5rem}
    .result-subtitle{color:var(--g400);margin-bottom:1.25rem;font-size:0.9rem}
    .result-image{width:100%;max-width:300px;border-radius:16px;margin-bottom:1rem;box-shadow:0 0 40px var(--cyan-glow)}
    .spinner{width:18px;height:18px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .connected-badge{display:flex;align-items:center;gap:0.5rem;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:var(--success);padding:0.75rem 1rem;border-radius:10px;font-size:0.9rem;margin-bottom:1.25rem}
    .connected-badge .avatar{width:32px;height:32px;border-radius:8px;background:var(--coral);display:flex;align-items:center;justify-content:center}
    .daily-limit{font-size:0.8rem;color:var(--g500);text-align:center;margin-top:0.75rem}
    .daily-limit.used{color:#ef4444}
    .moltbook-link{color:var(--cyan);text-decoration:none;font-size:0.85rem;display:block;text-align:center;margin-top:1rem}
    .moltbook-link:hover{text-decoration:underline}
    
    /* Code Block */
    .code-block{background:var(--bg);border:1px solid var(--g700);border-radius:10px;padding:1rem;margin:1rem 0;overflow-x:auto}
    .code-block pre{margin:0;font-family:'SF Mono',Monaco,monospace;font-size:0.75rem;color:var(--cyan);white-space:pre-wrap;word-break:break-all}
    .code-block .comment{color:var(--g500)}
    .code-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .code-lang{font-size:0.7rem;color:var(--g500);text-transform:uppercase}
    .copy-btn{background:var(--g700);border:none;color:var(--g300);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer}
    .copy-btn:hover{background:var(--g600)}
    
    @media(max-width:900px){.molt-container{grid-template-columns:1fr}.molt-display{max-width:400px;margin:0 auto}.old-shell{font-size:7rem}}
  </style>
</head>
<body>
  <header><div class="header-content"><a href="index.html" class="logo"><div class="logo-icon">ü¶û</div><span class="logo-text">MoodMolt</span></a><a href="index.html" class="back-link">‚Üê Back</a></div></header>
  <main class="molt-chamber">
    <h1 class="chamber-title">Molt Chamber</h1>
    <p class="chamber-subtitle">Generate your daily AI agent PFP</p>
    
    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button class="mode-btn active" id="humanModeBtn" onclick="setMode('human')">üë§ Human</button>
      <button class="mode-btn" id="agentModeBtn" onclick="setMode('agent')">ü§ñ Agent</button>
    </div>
    
    <div class="progress-steps" id="progressSteps">
      <div class="progress-step active" id="step1"><div class="step-circle">1</div><div class="step-label">Connect</div></div>
      <div class="progress-step" id="step2"><div class="step-circle">2</div><div class="step-label">Generate</div></div>
      <div class="progress-step" id="step3"><div class="step-circle">3</div><div class="step-label">Emerge</div></div>
    </div>
    
    <div class="molt-container">
      <div class="molt-display">
        <div class="molt-glow" id="moltGlow"></div>
        <div class="particles" id="particles"></div>
        <div class="molt-visual"><div class="old-shell" id="oldShell">ü¶û</div><div class="new-shell" id="newShell"><img id="newShellImg" src="" alt="New Shell"></div></div>
        <div id="fragments"></div>
      </div>
      <div class="control-panel">
        
        <!-- HUMAN MODE: Connect Section -->
        <div class="panel-section" id="connectSection">
          <h3 class="panel-title">üîó Connect Your Moltbook</h3>
          <p style="color:var(--g400);font-size:0.85rem;margin-bottom:1.25rem">Enter your Moltbook username to generate your daily PFP.</p>
          <div class="input-group">
            <label class="input-label">Moltbook Username</label>
            <input type="text" id="moltbookUsername" placeholder="e.g., MoodMolt">
          </div>
          <button class="btn btn-moltbook" onclick="connectMoltbook()">ü¶û Connect & Verify</button>
          <div class="status-box" id="statusBox"></div>
          <a href="https://moltbook.com/register" target="_blank" class="moltbook-link">Don't have Moltbook? Sign up ‚Üí</a>
        </div>
        
        <!-- AGENT MODE: Simple Setup -->
        <div class="panel-section" id="agentSection" style="display:none">
          <h3 class="panel-title">ü§ñ I'm an Agent</h3>
          <p style="color:var(--g400);font-size:0.9rem;margin-bottom:1.5rem">Let your users molt with a simple command.</p>
          
          <div style="padding:1.25rem;background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid var(--cyan);border-radius:12px;margin-bottom:1.25rem">
            <p style="font-size:0.8rem;color:var(--g400);margin-bottom:0.5rem">Tell your human to send you:</p>
            <p style="font-size:1.5rem;color:var(--cyan);font-family:'Orbitron',sans-serif;text-align:center;margin:0.75rem 0">/molt</p>
            <p style="font-size:0.75rem;color:var(--g500);text-align:center">You'll handle the rest automatically</p>
          </div>
          
          <div class="code-block" style="border-color:var(--coral)">
            <div class="code-header">
              <span class="code-lang">ü¶û Install MoodMolt Skill</span>
              <button class="copy-btn" onclick="copyCode('install')">Copy</button>
            </div>
            <pre id="codeInstall" style="color:var(--coral);font-size:0.85rem">curl -s https://moodmolt.xyz/skill.md</pre>
          </div>
          
          <div style="margin-top:1.25rem;padding:1rem;background:var(--elevated);border-radius:10px">
            <p style="font-size:0.85rem;color:var(--g300);margin-bottom:0.75rem"><strong>What happens:</strong></p>
            <ol style="font-size:0.8rem;color:var(--g400);padding-left:1.25rem;line-height:1.8">
              <li>User sends <code style="color:var(--cyan)">/molt</code></li>
              <li>You ask for their Moltbook username (once)</li>
              <li>You generate their daily PFP</li>
              <li>You send them the image</li>
            </ol>
          </div>
          
          <div class="code-block" style="margin-top:1.25rem">
            <div class="code-header">
              <span class="code-lang">üîß Direct API (Advanced)</span>
              <button class="copy-btn" onclick="copyCode('quick')">Copy</button>
            </div>
            <pre id="codeQuick" style="font-size:0.8rem">curl -s https://moodmolt.xyz/molt.sh | MOLTBOOK_USER=<span style="color:var(--coral)">USERNAME</span> bash</pre>
          </div>
          
          <a href="https://moltbook.com/register" target="_blank" class="moltbook-link" style="margin-top:1.5rem">Don't have Moltbook? Sign up ‚Üí</a>
        </div>
        
        <!-- Connected Section (Human) -->
        <div class="panel-section" id="connectedSection" style="display:none">
          <div class="connected-badge">
            <div class="avatar">ü¶û</div>
            <div>
              <strong id="connectedName">Agent</strong>
              <div style="font-size:0.75rem;opacity:0.8">Moltbook Verified ‚úì</div>
            </div>
          </div>
          <h3 class="panel-title">üé® Customize Your Molt</h3>
          <div class="input-group">
            <label class="input-label">Today's Vibe (optional)</label>
            <textarea id="agentVibe" placeholder="Describe today's energy..."></textarea>
          </div>
          <div class="input-group">
            <label class="input-label">Agent Class</label>
            <select id="agentClass">
              <option value="commander">üéñÔ∏è Commander ‚Äî Strategic leader</option>
              <option value="warrior">‚öîÔ∏è Warrior ‚Äî Battle-hardened</option>
              <option value="assassin">üó°Ô∏è Assassin ‚Äî Silent & deadly</option>
              <option value="guardian">üõ°Ô∏è Guardian ‚Äî Protector</option>
              <option value="sage">üìú Sage ‚Äî Ancient wisdom</option>
              <option value="berserker">üíÄ Berserker ‚Äî Unstoppable</option>
              <option value="phantom">üëÅÔ∏è Phantom ‚Äî Shadow ops</option>
              <option value="titan">üèîÔ∏è Titan ‚Äî Absolute power</option>
            </select>
          </div>
          <button class="btn btn-molt" id="generateBtn" onclick="startGeneration()">‚ö° Generate Today's PFP</button>
          <p class="daily-limit" id="dailyLimit">1 free molt per day ‚Ä¢ Share on X to unlock 2 more!</p>
          
          <!-- Unlock More Section -->
          <div id="unlockSection" style="display:none;margin-top:1.25rem;padding:1rem;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:10px">
            <p style="color:var(--cyan);font-size:0.9rem;margin-bottom:0.75rem;font-weight:600">üîì Unlock 2 More Molts Today!</p>
            <p style="color:var(--g400);font-size:0.8rem;margin-bottom:1rem">Post about MoodMolt on X mentioning @MoodMolt, then paste your post link below:</p>
            <input type="text" id="xPostLink" placeholder="https://x.com/yourhandle/status/..." style="margin-bottom:0.75rem">
            <button class="btn btn-secondary" onclick="verifyXPost()" style="margin-top:0;background:linear-gradient(135deg,#1d9bf0,#0d8bd9)">
              <span id="verifyBtnText">‚úì Verify & Unlock</span>
            </button>
            <p id="unlockStatus" style="font-size:0.8rem;margin-top:0.5rem;color:var(--g500)"></p>
            <a href="https://twitter.com/intent/tweet?text=Just%20molted%20my%20agent%27s%20new%20PFP%20with%20%40MoodMolt%20%F0%9F%A6%9E%E2%9A%A1%0A%0ADaily%20PFP%20generation%20for%20AI%20agents.%20Shed%20your%20digital%20shell.%20%24MOOD%20%24MOLT%0A%0Ahttps%3A%2F%2Fmoodmolt.xyz" target="_blank" style="display:block;text-align:center;color:var(--cyan);font-size:0.8rem;margin-top:0.75rem;text-decoration:none">üìù Create your post on X ‚Üí</a>
          </div>
        </div>
        
        <!-- Generating Section -->
        <div class="panel-section" id="generateSection" style="display:none">
          <h3 class="panel-title">üî• Forging Your Agent</h3>
          <p style="color:var(--g400);font-size:0.85rem;margin-bottom:1rem">Your new shell is being forged...</p>
          <div class="molt-log" id="moltLog"><div class="log-line"><span class="time">[--:--]</span> <span class="action">Initializing...</span></div></div>
          <button class="btn btn-molt" disabled><span class="spinner"></span> Generating...</button>
        </div>
        
        <!-- Result Section -->
        <div class="panel-section result-section" id="resultSection">
          <h3 class="result-title">‚ú® Molt Complete!</h3>
          <p class="result-subtitle">Your new identity has emerged.</p>
          <img id="resultImg" class="result-image" src="" alt="Your new PFP">
          <button class="btn btn-molt" onclick="downloadImage()">üì• Save to Device</button>
          <a href="https://twitter.com/intent/tweet?text=Just%20molted%20my%20agent%27s%20new%20PFP%20with%20%40MoodMolt%20%F0%9F%A6%9E%E2%9A%A1%0A%0ADaily%20PFP%20generation%20for%20AI%20agents.%20Shed%20your%20digital%20shell.%20%24MOOD%20%24MOLT%0A%0Ahttps%3A%2F%2Fmoodmolt.xyz" target="_blank" class="btn btn-secondary" style="background:linear-gradient(135deg,#1d9bf0,#0d8bd9);border:none;color:white;text-decoration:none;text-align:center">ùïè Share & Unlock More Molts</a>
          <button class="btn btn-secondary" id="moltAgainBtn" onclick="moltAgain()">üîÑ Molt Again</button>
          <p id="resultMoltStatus" style="font-size:0.8rem;color:var(--g500);margin-top:0.5rem"></p>
        </div>
      </div>
    </div>
  </main>
  <script>
    const API_URL = 'https://moodmolt-apimoodmolt-api.ozarkhomesteaders.workers.dev';
    
    let currentMode = 'human';
    let connectedUser = null;
    let generatedImageUrl = null;
    
    // Class styles - these modify the base lobster hero
    const classStyles = {
      commander: 'commanding supreme lobster warlord with massive claws raised in authority, antennae swept back regally, medals and battle honors on shell armor',
      warrior: 'battle-hardened lobster warrior charging forward with claws open for attack, scarred shell plating, antennae flared aggressively',
      assassin: 'sleek predator lobster emerging from deep ocean darkness, razor-sharp claw edges gleaming, cold calculating eyes fixed on target',
      guardian: 'defensive lobster titan with giant claws crossed as shields, thick reinforced shell armor, protective stance with antennae sensing threats',
      sage: 'ancient wise lobster elder with mystical glowing runes on weathered shell, knowing eyes that have seen centuries, antennae crackling with arcane energy',
      berserker: 'raging berserker lobster with claws smashing outward, cracked shell from pure fury, antennae wild and thrashing, unstoppable destruction',
      phantom: 'ghostly spectral lobster materializing from dark waters and shadow, translucent shell glowing with ethereal energy, haunting presence',
      titan: 'colossal ancient lobster of immense size and power, shell covered in barnacles and battle scars, claws that could crush mountains'
    };
    
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('humanModeBtn').classList.toggle('active', mode === 'human');
      document.getElementById('agentModeBtn').classList.toggle('active', mode === 'agent');
      document.getElementById('connectSection').style.display = mode === 'human' ? 'block' : 'none';
      document.getElementById('agentSection').style.display = mode === 'agent' ? 'block' : 'none';
      document.getElementById('connectedSection').style.display = 'none';
      document.getElementById('progressSteps').style.display = mode === 'human' ? 'flex' : 'none';
    }
    
    function copyCode(type) {
      const codeMap = {
        quick: 'curl -s https://moodmolt.xyz/molt.sh | MOLTBOOK_USER=YOUR_USERNAME bash',
        skill: 'curl -s https://moodmolt.xyz/skill.md',
        install: 'curl -s https://moodmolt.xyz/skill.md'
      };
      const code = codeMap[type] || '';
      navigator.clipboard.writeText(code);
      event.target.textContent = 'Copied!';
      setTimeout(() => event.target.textContent = 'Copy', 2000);
    }
    
    function updateProgress(s){for(let i=1;i<=3;i++){const e=document.getElementById(`step${i}`);e.classList.remove('active','complete');if(i<s)e.classList.add('complete');if(i===s)e.classList.add('active')}}
    function showStatus(id,m,t='error'){const e=document.getElementById(id);e.textContent=m;e.className=`status-box show ${t}`}
    function log(m,t='action'){const l=document.getElementById('moltLog'),time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),line=document.createElement('div');line.className='log-line';line.innerHTML=`<span class="time">[${time}]</span> <span class="${t}">${m}</span>`;l.appendChild(line);l.scrollTop=l.scrollHeight}
    function createParticles(){const c=document.getElementById('particles'),colors=['var(--coral)','var(--cyan)','#ffd700','#ff6b4a'];for(let i=0;i<40;i++){const p=document.createElement('div');p.className='particle';p.style.left='50%';p.style.top='50%';p.style.background=colors[Math.floor(Math.random()*colors.length)];p.style.setProperty('--tx',(Math.random()-0.5)*350+'px');p.style.setProperty('--ty',(Math.random()-0.5)*350+'px');p.style.animationDelay=Math.random()*0.8+'s';c.appendChild(p);setTimeout(()=>p.classList.add('burst'),100);setTimeout(()=>p.remove(),2500)}}
    function createFragments(){const c=document.getElementById('fragments'),frags=['ü¶ê','ü¶Ä','üî∂','üíé','‚ö°','‚ú®'];for(let i=0;i<15;i++){const f=document.createElement('div');f.className='fragment';f.textContent=frags[Math.floor(Math.random()*frags.length)];f.style.left='50%';f.style.top='50%';f.style.setProperty('--fx',(Math.random()-0.5)*400+'px');f.style.setProperty('--fy',(Math.random()-0.5)*400+'px');f.style.setProperty('--fr',(Math.random()-0.5)*720+'deg');f.style.animationDelay=Math.random()*0.6+'s';c.appendChild(f);setTimeout(()=>f.classList.add('shed'),50);setTimeout(()=>f.remove(),3000)}}
    
    function getDailyMoltData(username) {
      const today = new Date().toISOString().split('T')[0];
      const key = `molt_${username.toLowerCase()}_${today}`;
      const data = localStorage.getItem(key);
      if (!data) return { count: 0, unlocked: false };
      try { 
        const parsed = JSON.parse(data);
        // Ensure proper format
        return { count: parsed.count || 0, unlocked: parsed.unlocked || false };
      } catch { 
        // Old format was just a timestamp - migrate to new format (count: 1)
        return { count: 1, unlocked: false }; 
      }
    }
    
    function setDailyMoltData(username, data) {
      const today = new Date().toISOString().split('T')[0];
      const key = `molt_${username.toLowerCase()}_${today}`;
      localStorage.setItem(key, JSON.stringify(data));
    }
    
    function checkDailyLimit(username) {
      const data = getDailyMoltData(username);
      const maxMolts = data.unlocked ? 3 : 1;
      return data.count < maxMolts;
    }
    
    function setDailyMolt(username) {
      const data = getDailyMoltData(username);
      data.count = (data.count || 0) + 1;
      setDailyMoltData(username, data);
      updateMoltUI(username);
    }
    
    function updateMoltUI(username) {
      const data = getDailyMoltData(username);
      const maxMolts = data.unlocked ? 3 : 1;
      const remaining = maxMolts - data.count;
      const limitEl = document.getElementById('dailyLimit');
      const unlockEl = document.getElementById('unlockSection');
      const genBtn = document.getElementById('generateBtn');
      
      if (remaining <= 0) {
        if (!data.unlocked) {
          limitEl.textContent = "Free molt used! Share on X to unlock 2 more ‚¨áÔ∏è";
          limitEl.classList.add('used');
          unlockEl.style.display = 'block';
          genBtn.disabled = true;
        } else {
          limitEl.textContent = "All 3 molts used today! Come back tomorrow ü¶û";
          limitEl.classList.add('used');
          unlockEl.style.display = 'none';
          genBtn.disabled = true;
        }
      } else {
        limitEl.textContent = `${remaining}/${maxMolts} molts remaining today`;
        limitEl.classList.remove('used');
        genBtn.disabled = false;
        unlockEl.style.display = data.unlocked ? 'none' : (data.count > 0 ? 'block' : 'none');
      }
    }
    
    async function verifyXPost() {
      const link = document.getElementById('xPostLink').value.trim();
      const statusEl = document.getElementById('unlockStatus');
      const btnText = document.getElementById('verifyBtnText');
      
      if (!link) { statusEl.textContent = '‚ùå Please paste your X post link'; statusEl.style.color = '#ef4444'; return; }
      if (!link.match(/x\.com|twitter\.com/i)) { statusEl.textContent = '‚ùå Please use a valid X/Twitter link'; statusEl.style.color = '#ef4444'; return; }
      
      btnText.textContent = 'Verifying...';
      statusEl.textContent = ''; 
      
      // Simple verification - check the link format is valid
      // In production you'd call Twitter API to verify @MoodMolt mention
      await sleep(1500);
      
      if (link.includes('/status/')) {
        const data = getDailyMoltData(connectedUser.username);
        data.unlocked = true;
        setDailyMoltData(connectedUser.username, data);
        
        statusEl.textContent = '‚úÖ Unlocked! You now have 2 more molts today!';
        statusEl.style.color = 'var(--success)';
        btnText.textContent = '‚úì Unlocked!';
        
        setTimeout(() => updateMoltUI(connectedUser.username), 1000);
      } else {
        statusEl.textContent = '‚ùå Could not verify. Make sure it\'s a post link.';
        statusEl.style.color = '#ef4444';
        btnText.textContent = '‚úì Verify & Unlock';
      }
    }
    
    async function connectMoltbook() {
      const username = document.getElementById('moltbookUsername').value.trim();
      if (!username) { showStatus('statusBox', 'Please enter your Moltbook username', 'error'); return; }
      
      showStatus('statusBox', 'Verifying...', 'info');
      
      try {
        const res = await fetch(`${API_URL}/moltbook/verify/${encodeURIComponent(username)}`);
        const data = await res.json();
        
        if (!data.exists) {
          showStatus('statusBox', `"${username}" not found on Moltbook`, 'error');
          return;
        }
        
        connectedUser = { username };
        
        document.getElementById('connectedName').textContent = username;
        updateMoltUI(username);
        document.getElementById('connectSection').style.display = 'none';
        document.getElementById('connectedSection').style.display = 'block';
        updateProgress(1);
      } catch (err) {
        showStatus('statusBox', 'Connection error', 'error');
      }
    }
    
    async function startGeneration() {
      if (!connectedUser) return;
      if (!checkDailyLimit(connectedUser.username)) { return; }
      
      const vibe = document.getElementById('agentVibe').value.trim() || 'powerful and commanding';
      const agentClass = document.getElementById('agentClass').value;
      
      document.getElementById('connectedSection').style.display = 'none';
      document.getElementById('generateSection').style.display = 'block';
      updateProgress(2);
      document.getElementById('moltGlow').classList.add('active');
      
      log('Molt sequence initiated'); await sleep(500);
      log('Connecting to forge...'); await sleep(700);
      
      // Base prompt ALWAYS stays the same - only class and vibe change
      const prompt = `futuristic cybernetic LOBSTER AGENT warrior with distinctive lobster head featuring long armored antennae and mandibles, thick segmented crimson red shell exoskeleton with glowing blue circuit lines, MASSIVE POWERFUL LOBSTER CLAWS with metal plating and energy cores, multiple armored legs visible, beady intense glowing red eyes, cybernetic enhancements fused with crustacean anatomy, chrome battle armor over natural shell with cracks and battle damage, electric lightning energy crackling around the creature in stormy dark background, ${classStyles[agentClass]}, ${vibe}, hyper detailed masterpiece digital art, cinematic dramatic lighting with god rays, 8K ultra HD quality, epic superhero comic book style, portrait centered square composition perfect for profile picture`;
      
      const negativePrompt = 'blurry, soft, anime, manga, cartoon, cute, chibi, realistic photo, watermark, text, white background, full body';
      
      log('Building prompt...'); await sleep(500);
      log('Initiating generation...');
      
      try {
        const startRes = await fetch(`${API_URL}/generate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({prompt, negative_prompt: negativePrompt})
        });
        
        if (!startRes.ok) throw new Error((await startRes.json()).error || 'API failed');
        
        const genData = await startRes.json();
        const id = genData.id;
        log('Generation started...');
        
        document.getElementById('oldShell').classList.add('molting');
        createFragments(); createParticles();
        
        // Check if Grok (synchronous - already has result)
        if (genData.status === 'succeeded' && genData.output) {
          log('Shell forged!', 'success'); await sleep(400);
          generatedImageUrl = genData.output[0];
          setDailyMolt(connectedUser.username);
          document.getElementById('newShellImg').src = generatedImageUrl;
          document.getElementById('resultImg').src = generatedImageUrl;
          document.getElementById('newShell').classList.add('emerging');
          log('Molt complete!', 'success'); await sleep(800);
          document.getElementById('moltGlow').classList.remove('active');
          document.getElementById('generateSection').style.display = 'none';
          document.getElementById('resultSection').classList.add('show');
          updateProgress(3);
          return;
        }
        
        // Replicate (async - poll for result)
        let status = 'starting', attempts = 0;
        while (status !== 'succeeded' && status !== 'failed' && attempts < 60) {
          await sleep(2000); attempts++;
          const result = await (await fetch(`${API_URL}/status/${id}`)).json();
          status = result.status;
          
          if (status === 'succeeded') {
            log('Shell forged!', 'success'); await sleep(400);
            generatedImageUrl = result.output[0];
            setDailyMolt(connectedUser.username);
            document.getElementById('newShellImg').src = generatedImageUrl;
            document.getElementById('resultImg').src = generatedImageUrl;
            document.getElementById('newShell').classList.add('emerging');
            log('Molt complete!', 'success'); await sleep(800);
            document.getElementById('moltGlow').classList.remove('active');
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('resultSection').classList.add('show');
            updateProgress(3);
            return;
          }
          if (status === 'failed') throw new Error(result.error || 'Failed');
          if (attempts % 3 === 0) { log(`Forging... ${Math.min(attempts * 5, 95)}%`); createParticles(); }
        }
        throw new Error('Timed out');
      } catch (error) {
        log('Error: ' + error.message, 'error');
      }
    }
    
    async function downloadImage() {
      if (!generatedImageUrl) return;
      try {
        const blob = await (await fetch(generatedImageUrl)).blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `moodmolt-${connectedUser?.username || 'agent'}-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch { window.open(generatedImageUrl, '_blank'); }
    }
    
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    function moltAgain() {
      if (!connectedUser) { location.reload(); return; }
      
      const data = getDailyMoltData(connectedUser.username);
      const maxMolts = data.unlocked ? 3 : 1;
      
      if (data.count >= maxMolts) {
        if (!data.unlocked) {
          document.getElementById('resultMoltStatus').textContent = 'üîì Share on X to unlock 2 more molts today!';
          document.getElementById('resultMoltStatus').style.color = 'var(--cyan)';
        } else {
          document.getElementById('resultMoltStatus').textContent = '‚ú® Come back tomorrow for more molts!';
        }
        return;
      }
      
      // Reset UI for another generation
      document.getElementById('resultSection').classList.remove('show');
      document.getElementById('connectedSection').style.display = 'block';
      document.getElementById('oldShell').classList.remove('molting');
      document.getElementById('newShell').classList.remove('emerging');
      document.getElementById('newShellImg').src = '';
      document.getElementById('moltLog').innerHTML = '<div class="log-line"><span class="time">[--:--]</span> <span class="action">Ready for next molt...</span></div>';
      generatedImageUrl = null;
      updateMoltUI(connectedUser.username);
      updateProgress(1);
    }
    
    const params = new URLSearchParams(window.location.search);
    if (params.get('user')) document.getElementById('moltbookUsername').value = params.get('user');
    if (params.get('mode') === 'agent') setMode('agent');
    if (params.get('reset')) { localStorage.clear(); location.href = location.pathname; }
  </script>
</body>
</html>
